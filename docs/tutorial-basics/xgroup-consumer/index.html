<!doctype html>
<html lang="en" dir="ltr" class="docs-wrapper plugin-docs plugin-id-default docs-version-current docs-doc-page docs-doc-id-tutorial-basics/xgroup-consumer" data-has-hydrated="false">
<head>
<meta charset="UTF-8">
<meta name="generator" content="Docusaurus v3.8.1">
<title data-rh="true">XGROUP ... | Spring Data Redis</title><meta data-rh="true" name="viewport" content="width=device-width,initial-scale=1"><meta data-rh="true" name="twitter:card" content="summary_large_image"><meta data-rh="true" property="og:image" content="https://loongest.github.io/spring-data-redis-streams/img/docusaurus-social-card.jpg"><meta data-rh="true" name="twitter:image" content="https://loongest.github.io/spring-data-redis-streams/img/docusaurus-social-card.jpg"><meta data-rh="true" property="og:url" content="https://loongest.github.io/spring-data-redis-streams/docs/tutorial-basics/xgroup-consumer/"><meta data-rh="true" property="og:locale" content="en"><meta data-rh="true" name="docusaurus_locale" content="en"><meta data-rh="true" name="docsearch:language" content="en"><meta data-rh="true" name="docusaurus_version" content="current"><meta data-rh="true" name="docusaurus_tag" content="docs-default-current"><meta data-rh="true" name="docsearch:version" content="current"><meta data-rh="true" name="docsearch:docusaurus_tag" content="docs-default-current"><meta data-rh="true" property="og:title" content="XGROUP ... | Spring Data Redis"><meta data-rh="true" name="description" content="In this section, we&#x27;ll dive into the concept of Consumers and Groups in Redis Streams. The term &quot;consumer&quot; only matters within a consumer group context."><meta data-rh="true" property="og:description" content="In this section, we&#x27;ll dive into the concept of Consumers and Groups in Redis Streams. The term &quot;consumer&quot; only matters within a consumer group context."><link data-rh="true" rel="icon" href="/spring-data-redis-streams/img/favicon.ico"><link data-rh="true" rel="canonical" href="https://loongest.github.io/spring-data-redis-streams/docs/tutorial-basics/xgroup-consumer/"><link data-rh="true" rel="alternate" href="https://loongest.github.io/spring-data-redis-streams/docs/tutorial-basics/xgroup-consumer/" hreflang="en"><link data-rh="true" rel="alternate" href="https://loongest.github.io/spring-data-redis-streams/docs/tutorial-basics/xgroup-consumer/" hreflang="x-default"><script data-rh="true" type="application/ld+json">{"@context":"https://schema.org","@type":"BreadcrumbList","itemListElement":[{"@type":"ListItem","position":1,"name":"Tutorial - Basics","item":"https://loongest.github.io/spring-data-redis-streams/docs/category/tutorial---basics"},{"@type":"ListItem","position":2,"name":"XGROUP ...","item":"https://loongest.github.io/spring-data-redis-streams/docs/tutorial-basics/xgroup-consumer"}]}</script><link rel="alternate" type="application/rss+xml" href="/spring-data-redis-streams/blog/rss.xml" title="Spring Data Redis RSS Feed">
<link rel="alternate" type="application/atom+xml" href="/spring-data-redis-streams/blog/atom.xml" title="Spring Data Redis Atom Feed"><link rel="stylesheet" href="/spring-data-redis-streams/assets/css/styles.61e3011e.css">
<script src="/spring-data-redis-streams/assets/js/runtime~main.3f5b7c9c.js" defer="defer"></script>
<script src="/spring-data-redis-streams/assets/js/main.cfbac9c2.js" defer="defer"></script>
</head>
<body class="navigation-with-keyboard">
<svg xmlns="http://www.w3.org/2000/svg" style="display: none;"><defs>
<symbol id="theme-svg-external-link" viewBox="0 0 24 24"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"/></symbol>
</defs></svg>
<script>!function(){var t="light";var e=function(){try{return new URLSearchParams(window.location.search).get("docusaurus-theme")}catch(t){}}()||function(){try{return window.localStorage.getItem("theme")}catch(t){}}();document.documentElement.setAttribute("data-theme",e||t),document.documentElement.setAttribute("data-theme-choice",e||t)}(),function(){try{const c=new URLSearchParams(window.location.search).entries();for(var[t,e]of c)if(t.startsWith("docusaurus-data-")){var a=t.replace("docusaurus-data-","data-");document.documentElement.setAttribute(a,e)}}catch(t){}}()</script><div id="__docusaurus"><link rel="preload" as="image" href="/spring-data-redis-streams/img/logo.svg"><div role="region" aria-label="Skip to main content"><a class="skipToContent_fXgn" href="#__docusaurus_skipToContent_fallback">Skip to main content</a></div><nav aria-label="Main" class="theme-layout-navbar navbar navbar--fixed-top"><div class="navbar__inner"><div class="theme-layout-navbar-left navbar__items"><button aria-label="Toggle navigation bar" aria-expanded="false" class="navbar__toggle clean-btn" type="button"><svg width="30" height="30" viewBox="0 0 30 30" aria-hidden="true"><path stroke="currentColor" stroke-linecap="round" stroke-miterlimit="10" stroke-width="2" d="M4 7h22M4 15h22M4 23h22"></path></svg></button><a class="navbar__brand" href="/spring-data-redis-streams/"><div class="navbar__logo"><img src="/spring-data-redis-streams/img/logo.svg" alt="My Site Logo" class="themedComponent_mlkZ themedComponent--light_NVdE"><img src="/spring-data-redis-streams/img/logo.svg" alt="My Site Logo" class="themedComponent_mlkZ themedComponent--dark_xIcU"></div><b class="navbar__title text--truncate">Home</b></a><a aria-current="page" class="navbar__item navbar__link navbar__link--active" href="/spring-data-redis-streams/docs/intro/">Tutorial</a></div><div class="theme-layout-navbar-right navbar__items navbar__items--right"><a href="https://github.com/facebook/docusaurus" target="_blank" rel="noopener noreferrer" class="navbar__item navbar__link">GitHub<svg width="13.5" height="13.5" aria-hidden="true" class="iconExternalLink_nPIU"><use href="#theme-svg-external-link"></use></svg></a><div class="toggle_vylO colorModeToggle_DEke"><button class="clean-btn toggleButton_gllP toggleButtonDisabled_aARS" type="button" disabled="" title="system mode" aria-label="Switch between dark and light mode (currently system mode)"><svg viewBox="0 0 24 24" width="24" height="24" aria-hidden="true" class="toggleIcon_g3eP lightToggleIcon_pyhR"><path fill="currentColor" d="M12,9c1.65,0,3,1.35,3,3s-1.35,3-3,3s-3-1.35-3-3S10.35,9,12,9 M12,7c-2.76,0-5,2.24-5,5s2.24,5,5,5s5-2.24,5-5 S14.76,7,12,7L12,7z M2,13l2,0c0.55,0,1-0.45,1-1s-0.45-1-1-1l-2,0c-0.55,0-1,0.45-1,1S1.45,13,2,13z M20,13l2,0c0.55,0,1-0.45,1-1 s-0.45-1-1-1l-2,0c-0.55,0-1,0.45-1,1S19.45,13,20,13z M11,2v2c0,0.55,0.45,1,1,1s1-0.45,1-1V2c0-0.55-0.45-1-1-1S11,1.45,11,2z M11,20v2c0,0.55,0.45,1,1,1s1-0.45,1-1v-2c0-0.55-0.45-1-1-1C11.45,19,11,19.45,11,20z M5.99,4.58c-0.39-0.39-1.03-0.39-1.41,0 c-0.39,0.39-0.39,1.03,0,1.41l1.06,1.06c0.39,0.39,1.03,0.39,1.41,0s0.39-1.03,0-1.41L5.99,4.58z M18.36,16.95 c-0.39-0.39-1.03-0.39-1.41,0c-0.39,0.39-0.39,1.03,0,1.41l1.06,1.06c0.39,0.39,1.03,0.39,1.41,0c0.39-0.39,0.39-1.03,0-1.41 L18.36,16.95z M19.42,5.99c0.39-0.39,0.39-1.03,0-1.41c-0.39-0.39-1.03-0.39-1.41,0l-1.06,1.06c-0.39,0.39-0.39,1.03,0,1.41 s1.03,0.39,1.41,0L19.42,5.99z M7.05,18.36c0.39-0.39,0.39-1.03,0-1.41c-0.39-0.39-1.03-0.39-1.41,0l-1.06,1.06 c-0.39,0.39-0.39,1.03,0,1.41s1.03,0.39,1.41,0L7.05,18.36z"></path></svg><svg viewBox="0 0 24 24" width="24" height="24" aria-hidden="true" class="toggleIcon_g3eP darkToggleIcon_wfgR"><path fill="currentColor" d="M9.37,5.51C9.19,6.15,9.1,6.82,9.1,7.5c0,4.08,3.32,7.4,7.4,7.4c0.68,0,1.35-0.09,1.99-0.27C17.45,17.19,14.93,19,12,19 c-3.86,0-7-3.14-7-7C5,9.07,6.81,6.55,9.37,5.51z M12,3c-4.97,0-9,4.03-9,9s4.03,9,9,9s9-4.03,9-9c0-0.46-0.04-0.92-0.1-1.36 c-0.98,1.37-2.58,2.26-4.4,2.26c-2.98,0-5.4-2.42-5.4-5.4c0-1.81,0.89-3.42,2.26-4.4C12.92,3.04,12.46,3,12,3L12,3z"></path></svg><svg viewBox="0 0 24 24" width="24" height="24" aria-hidden="true" class="toggleIcon_g3eP systemToggleIcon_QzmC"><path fill="currentColor" d="m12 21c4.971 0 9-4.029 9-9s-4.029-9-9-9-9 4.029-9 9 4.029 9 9 9zm4.95-13.95c1.313 1.313 2.05 3.093 2.05 4.95s-0.738 3.637-2.05 4.95c-1.313 1.313-3.093 2.05-4.95 2.05v-14c1.857 0 3.637 0.737 4.95 2.05z"></path></svg></button></div><div class="navbarSearchContainer_Bca1"></div></div></div><div role="presentation" class="navbar-sidebar__backdrop"></div></nav><div id="__docusaurus_skipToContent_fallback" class="theme-layout-main main-wrapper mainWrapper_z2l0"><div class="docsWrapper_hBAB"><button aria-label="Scroll back to top" class="clean-btn theme-back-to-top-button backToTopButton_sjWU" type="button"></button><div class="docRoot_UBD9"><aside class="theme-doc-sidebar-container docSidebarContainer_YfHR"><div class="sidebarViewport_aRkj"><div class="sidebar_njMd"><nav aria-label="Docs sidebar" class="menu thin-scrollbar menu_SIkG"><ul class="theme-doc-sidebar-menu menu__list"><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-1 menu__list-item"><a class="menu__link" href="/spring-data-redis-streams/docs/intro/">Tutorial Intro</a></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--active" href="/spring-data-redis-streams/docs/category/tutorial---basics/">Tutorial - Basics</a><button aria-label="Collapse sidebar category &#x27;Tutorial - Basics&#x27;" aria-expanded="true" type="button" class="clean-btn menu__caret"></button></div><ul class="menu__list"><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/spring-data-redis-streams/docs/tutorial-basics/create-a-page/">Redis Stream Commands</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/spring-data-redis-streams/docs/tutorial-basics/xadd/">XADD</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/spring-data-redis-streams/docs/tutorial-basics/xrange/">XRANGE</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/spring-data-redis-streams/docs/tutorial-basics/xrevrange/">XREVRANGE</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/spring-data-redis-streams/docs/tutorial-basics/xlen/">XLEN</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/spring-data-redis-streams/docs/tutorial-basics/xinfo-stream/">XINFO STREAM</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/spring-data-redis-streams/docs/tutorial-basics/xread/">XREAD</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link menu__link--active" aria-current="page" tabindex="0" href="/spring-data-redis-streams/docs/tutorial-basics/xgroup-consumer/">XGROUP ...</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/spring-data-redis-streams/docs/tutorial-basics/xack/">XACK</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/spring-data-redis-streams/docs/tutorial-basics/xclaim/">XCLAIM</a></li></ul></li></ul></nav></div></div></aside><main class="docMainContainer_TBSr"><div class="container padding-top--md padding-bottom--lg"><div class="row"><div class="col docItemCol_VOVn"><div class="docItemContainer_Djhp"><article><nav class="theme-doc-breadcrumbs breadcrumbsContainer_Z_bl" aria-label="Breadcrumbs"><ul class="breadcrumbs"><li class="breadcrumbs__item"><a aria-label="Home page" class="breadcrumbs__link" href="/spring-data-redis-streams/"><svg viewBox="0 0 24 24" class="breadcrumbHomeIcon_YNFT"><path d="M10 19v-5h4v5c0 .55.45 1 1 1h3c.55 0 1-.45 1-1v-7h1.7c.46 0 .68-.57.33-.87L12.67 3.6c-.38-.34-.96-.34-1.34 0l-8.36 7.53c-.34.3-.13.87.33.87H5v7c0 .55.45 1 1 1h3c.55 0 1-.45 1-1z" fill="currentColor"></path></svg></a></li><li class="breadcrumbs__item"><a class="breadcrumbs__link" href="/spring-data-redis-streams/docs/category/tutorial---basics/"><span>Tutorial - Basics</span></a></li><li class="breadcrumbs__item breadcrumbs__item--active"><span class="breadcrumbs__link">XGROUP ...</span></li></ul></nav><div class="tocCollapsible_ETCw theme-doc-toc-mobile tocMobile_ITEo"><button type="button" class="clean-btn tocCollapsibleButton_TO0P">On this page</button></div><div class="theme-doc-markdown markdown"><header><h1>XGROUP ...</h1></header>
<p>In this section, we&#x27;ll dive into the concept of <strong>Consumers</strong> and <strong>Groups</strong> in Redis Streams. The term <em>&quot;consumer&quot;</em> only matters <strong>within a consumer group</strong> context.</p>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="redis-cli">Redis CLI<a href="#redis-cli" class="hash-link" aria-label="Direct link to Redis CLI" title="Direct link to Redis CLI">​</a></h2>
<p>As usual, we’ll use Redis CLI to test and understand how to work with groups and consumers before applying it in Spring Data Redis.</p>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="create-group-mandatory">Create Group (Mandatory)<a href="#create-group-mandatory" class="hash-link" aria-label="Direct link to Create Group (Mandatory)" title="Direct link to Create Group (Mandatory)">​</a></h2>
<p>Before using consumer groups, you <strong>must create a group</strong>. This is a <strong>one-time setup</strong>.</p>
<div class="language-text codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">XGROUP CREATE race:france race-group 0 MKSTREAM</span><br></span></code></pre></div></div>
<p>What it does?</p>
<ul>
<li>Creates a consumer group named race-group <em><strong>(can be any name)</strong></em></li>
<li>Associated with stream <strong>race<!-- -->:france</strong></li>
<li>Starting from ID 0 (i.e., from the beginning)<!-- -->
<ul>
<li><code>0</code> Start from the beginning of the stream (include all existing messages)</li>
<li><code>$</code> Start from the latest message (only process new messages added after the group is created)</li>
<li><code>&lt;specific-id&gt;</code> Start from a specific stream ID like 1692900280032-0</li>
</ul>
</li>
<li>If stream doesn’t exist yet, <strong>MKSTREAM</strong> will create it</li>
</ul>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="consumer-creation-optional">Consumer Creation (Optional)<a href="#consumer-creation-optional" class="hash-link" aria-label="Direct link to Consumer Creation (Optional)" title="Direct link to Consumer Creation (Optional)">​</a></h2>
<p>Think of it as: &quot;Hey Redis, just letting you know consumer-B exists.&quot; (But it&#x27;s not doing anything yet.)</p>
<div class="language-text codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">XGROUP CREATECONSUMER race:france race-group consumer-B</span><br></span></code></pre></div></div>
<ul>
<li>Creates a new consumer named <strong>consumer-B</strong></li>
<li>Registers it under group race-group for stream race<!-- -->:france</li>
<li>Does NOT start reading any messages</li>
<li>Used mainly for:<!-- -->
<ul>
<li>Pre-registering</li>
<li>Monitoring via <code>XINFO CONSUMERS</code></li>
</ul>
</li>
<li>⚠️ It will fail if the group doesn’t already exist.<!-- -->
<div class="language-text codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">(error) NOGROUP No such consumer group &#x27;race-group&#x27; for key name &#x27;race:france&#x27;</span><br></span></code></pre></div></div>
</li>
</ul>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="consuming-messages">Consuming Messages<a href="#consuming-messages" class="hash-link" aria-label="Direct link to Consuming Messages" title="Direct link to Consuming Messages">​</a></h2>
<p>To actually start reading messages with a consumer:</p>
<div class="language-text codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">XREADGROUP GROUP race-group consumer-B STREAMS race:france &gt;</span><br></span></code></pre></div></div>
<ul>
<li>Creates consumer-B if not already exists (a shorthand of <code>XGROUP CREATECONSUMER</code>)</li>
<li>Starts consuming messages from race<!-- -->:france</li>
<li>Uses group race-group to track delivery, pending and acknowledgments</li>
<li>Will return unacknowledged messages previously sent to this consumer</li>
<li>⚠️ It will fail if the group doesn’t already exist.<!-- -->
<div class="language-text codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">(error) NOGROUP No such consumer group &#x27;race-group&#x27; for key name &#x27;race:france&#x27;</span><br></span></code></pre></div></div>
</li>
<li>Redis Stream entry ID options for reading<!-- -->
<table><thead><tr><th>Symbol.</th><th>Meaning</th></tr></thead><tbody><tr><td><code>&gt;</code></td><td>Get <strong>new messages</strong> not yet delivered</td></tr><tr><td><code>0</code>, <code>0-0</code></td><td>Return unacknowledged messages for this group from the start (use for retries)</td></tr><tr><td><code>&lt;specific-id&gt; </code></td><td>Start from only <strong>new</strong> messages going forward</td></tr></tbody></table>
</li>
</ul>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="full-example">Full example<a href="#full-example" class="hash-link" aria-label="Direct link to Full example" title="Direct link to Full example">​</a></h2>
<div class="language-text codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain"># 1. Create stream &amp; group</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">XGROUP CREATE race:france race-group 0 MKSTREAM</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"># 2. (Optional) Create consumer</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">XGROUP CREATECONSUMER race:france race-group consumer-B</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"># 3. Start consuming</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">XREADGROUP GROUP race-group consumer-B COUNT 10 BLOCK 5000 STREAMS race:france &gt;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"># 4. Optionally: Acknowledge processed messages (Will be cover next)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">XACK race:france race-group &lt;message-id&gt;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><br></span></code></pre></div></div>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="understanding-behavior-of-xgroup-create--0--">Understanding Behavior of XGROUP CREATE ... 0 + &gt;<a href="#understanding-behavior-of-xgroup-create--0--" class="hash-link" aria-label="Direct link to Understanding Behavior of XGROUP CREATE ... 0 + &gt;" title="Direct link to Understanding Behavior of XGROUP CREATE ... 0 + &gt;">​</a></h2>
<ol>
<li>You create a group <code>XGROUP CREATE race:france race-group 0 MKSTREAM</code></li>
<li>Redis assumes this group has seen nothing yet — starting at ID 0.</li>
<li>When calling:<!-- -->
<div class="language-text codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain"> XREADGROUP GROUP race-group consumer-B STREAMS race:france &gt;</span><br></span></code></pre></div></div>
</li>
<li>Redis interprets it as:<!-- -->
<ul>
<li>“Give me entries that have not yet been delivered to anyone in this group.”</li>
</ul>
</li>
<li>So even if 50 messages were added earlier, they’re still undelivered → Redis returns them</li>
</ol>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="practice-1--using--to-fetch-in-batches">Practice #1 – Using &gt; to Fetch in Batches<a href="#practice-1--using--to-fetch-in-batches" class="hash-link" aria-label="Direct link to Practice #1 – Using &gt; to Fetch in Batches" title="Direct link to Practice #1 – Using &gt; to Fetch in Batches">​</a></h2>
<p>Run this twice to observe batch consumption:</p>
<div class="language-text codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">127.0.0.1:6379&gt; XREADGROUP GROUP race-group consumer-B COUNT 10 BLOCK 5000 STREAMS race:france &gt;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">1) 1) &quot;race:france&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">   2)  1) 1) &quot;1754477775952-0&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">          2) 1) &quot;rider&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">             2) &quot;Moreira&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">             3) &quot;speed&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">             4) &quot;34.4&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">             5) &quot;position&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">             6) &quot;1&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">             7) &quot;location_id&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">             8) &quot;1&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">       ....</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      10) 1) &quot;1754477775952-9&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">          2) 1) &quot;rider&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">             2) &quot;Pogacar&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">             3) &quot;speed&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">             4) &quot;30.3&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">             5) &quot;position&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">             6) &quot;10&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">             7) &quot;location_id&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">             8) &quot;3&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">127.0.0.1:6379&gt; XREADGROUP GROUP race-group consumer-B COUNT 10 BLOCK 5000 STREAMS race:france &gt;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">1) 1) &quot;race:france&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">   2)  1) 1) &quot;1754479265672-10&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">          2) 1) &quot;rider&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">             2) &quot;Fernandez&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">             3) &quot;speed&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">             4) &quot;29.6&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">             5) &quot;position&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">             6) &quot;11&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">             7) &quot;location_id&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">             8) &quot;1&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">             ,,,   </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      10) 1) &quot;1754479265672-19&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">          2) 1) &quot;rider&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">             2) &quot;Lopez&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">             3) &quot;speed&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">             4) &quot;20.1&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">             5) &quot;position&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">             6) &quot;20&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">             7) &quot;location_id&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">             8) &quot;3&quot;                       </span><br></span></code></pre></div></div>
<table><thead><tr><th>Call</th><th>What Happens</th></tr></thead><tbody><tr><td>1st</td><td>Returns 10 unseen messages</td></tr><tr><td>2nd</td><td>Returns next 10</td></tr><tr><td>...</td><td>Until all 50 are seen</td></tr><tr><td>After all 50</td><td>Returns nothing until new <code>XADD</code></td></tr></tbody></table>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="practice-2--using-0-to-fetch-pending-messages">Practice #2 – Using 0 to Fetch Pending Messages<a href="#practice-2--using-0-to-fetch-pending-messages" class="hash-link" aria-label="Direct link to Practice #2 – Using 0 to Fetch Pending Messages" title="Direct link to Practice #2 – Using 0 to Fetch Pending Messages">​</a></h2>
<p>Fetch messages that were already delivered to this group but not yet acknowledged (in other words, pending messages)</p>
<div class="language-text codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">127.0.0.1:6379&gt; XREADGROUP GROUP race-group consumer-B STREAMS race:france 0</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">1) 1) &quot;race:france&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">   2)  1) 1) &quot;1754477775952-0&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">          2) 1) &quot;rider&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">             2) &quot;Moreira&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">             3) &quot;speed&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">             4) &quot;34.4&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">             5) &quot;position&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">             6) &quot;1&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">             7) &quot;location_id&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">             8) &quot;1&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      ..... </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      20) 1) &quot;1754477775952-19&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">          2) 1) &quot;rider&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">             2) &quot;Vingegaard&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">             3) &quot;speed&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">             4) &quot;22.2&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">             5) &quot;position&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">             6) &quot;20&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">             7) &quot;location_id&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">             8) &quot;1&quot;</span><br></span></code></pre></div></div>
<h4 class="anchor anchorWithStickyNavbar_LWe7" id="what-it-means">What it means?<a href="#what-it-means" class="hash-link" aria-label="Direct link to What it means?" title="Direct link to What it means?">​</a></h4>
<ul>
<li>Give me messages that were previously delivered to consumer-B but not yet acknowledged (aka: pending)<!-- -->
<ul>
<li>In ourcase return 20 records that had been consumed.</li>
</ul>
</li>
<li>However, if Redis returns empty array, so:<!-- -->
<ul>
<li>consumer-B has not received any messages yet</li>
</ul>
<div class="language-text codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">1) 1) &quot;race:france&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">   2) (empty array)</span><br></span></code></pre></div></div>
</li>
</ul>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="confirm-with-xpending">Confirm with XPENDING<a href="#confirm-with-xpending" class="hash-link" aria-label="Direct link to Confirm with XPENDING" title="Direct link to Confirm with XPENDING">​</a></h2>
<div class="language-text codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">XPENDING race:france race-group</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">1) (integer) 20                       ← Total **pending** (unacknowledged) messages</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">2) &quot;1754477775952-0&quot;                  ← The smallest pending message ID</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">3) &quot;1754477775952-19&quot;                 ← The largest pending message ID</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">4) 1) 1) &quot;consumer-B&quot;                 ← The only consumer with pending messages</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      2) &quot;20&quot;                         ← Count of pending messages for consumer-B</span><br></span></code></pre></div></div>
<ul>
<li>consumer-B has 20 pending messages → ✅ means Redis has delivered 20 messages to it.</li>
<li>The IDs range from <code>1754477775952-0</code> to <code>1754477775952-19</code></li>
<li>Those entries are still unacknowledged (you haven’t called XACK).</li>
</ul>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="adding-more-consumers">Adding More Consumers<a href="#adding-more-consumers" class="hash-link" aria-label="Direct link to Adding More Consumers" title="Direct link to Adding More Consumers">​</a></h2>
<p>Let’s create consumer-C to process more:</p>
<div class="language-text codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain"># 1. (Optional) Create consumer</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">&gt; XGROUP CREATECONSUMER race:france race-group consumer-C</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"># 2 Start consuming</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">&gt; XREADGROUP GROUP race-group consumer-C STREAMS race:france &gt;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"># 3 Inspect the result</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">&gt; XPENDING race:france race-group</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">1) (integer) 50</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">2) &quot;1754477775952-0&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">3) &quot;1754477775952-49&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">4) 1) 1) &quot;consumer-B&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      2) &quot;20&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">   2) 1) &quot;consumer-C&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      2) &quot;30&quot;</span><br></span></code></pre></div></div>
<p>✅ All 50 messages were distributed but still unacknowledged.</p>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="spring-data-redis-integration">Spring Data Redis Integration<a href="#spring-data-redis-integration" class="hash-link" aria-label="Direct link to Spring Data Redis Integration" title="Direct link to Spring Data Redis Integration">​</a></h2>
<div class="theme-admonition theme-admonition-warning admonition_xJq3 alert alert--warning"><div class="admonitionHeading_Gvgb"><span class="admonitionIcon_Rf37"><svg viewBox="0 0 16 16"><path fill-rule="evenodd" d="M8.893 1.5c-.183-.31-.52-.5-.887-.5s-.703.19-.886.5L.138 13.499a.98.98 0 0 0 0 1.001c.193.31.53.501.886.501h13.964c.367 0 .704-.19.877-.5a1.03 1.03 0 0 0 .01-1.002L8.893 1.5zm.133 11.497H6.987v-2.003h2.039v2.003zm0-3.004H6.987V5.987h2.039v4.006z"></path></svg></span>Important</div><div class="admonitionContent_BuS1"><p>In each of the examples, I use <code>FLUSHDB</code> to ensure the database starts clean. <strong>Be careful</strong>: if you have an existing Redis instance running on your local machine, <code>FLUSHDB</code> will <strong>delete all data in the current database</strong>.</p><p>If you&#x27;re unsure or want to avoid losing important data, the safer approach is to <strong>delete only the specific key</strong>:</p><div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">redis-cli DEL race:france</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">redis-cli --eval generate_race.lua race:france , 50</span><br></span></code></pre></div></div></div></div>
<p>Create spring boot project with following commands, this time we&#x27;ll use h2 and Spring data JPA as well to process the data.</p>
<div class="language-text codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">spring init -d=web,data-redis,data-jpa,h2,devtools,thymeleaf,lombok \</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  -g com.example \</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  -a demo \</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  -p jar \</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  --build maven \</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  xgroup -x</span><br></span></code></pre></div></div>
<p>add the following to application.yaml</p>
<div class="language-text codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">spring:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  data:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    redis:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      host: localhost</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      port: 6379</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  h2:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    console:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      enabled: true</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      path: /h2-console</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  datasource:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    name: example</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    username: sa</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    password:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    generate-unique-name: false</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    url: jdbc:h2:mem:testdb</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    driver-class-name: org.h2.Driver</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  sql:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    init:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      mode: never</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  jpa:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    open-in-view: false</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    show-sql: true</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    generate-ddl: true</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    properties:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      hibernate:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        jdbc:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">          lob:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            non_contextual_creation: true</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        format_sql: true</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        generate_statistics: true</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    hibernate:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      ddl-auto: create-drop</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">logging:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  level:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    root: INFO</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    org:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      springframework:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        security: TRACE</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        web:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">          reactive:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            function:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">              client: DEBUG</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      hibernate:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        SQL: DEBUG</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        orm:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">          jdbc:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            bind: TRACE</span><br></span></code></pre></div></div>
<p>RaceStreamEntity.java</p>
<div class="language-text codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">@Entity</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">@Table(name = &quot;race_stream_entry&quot;)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">@Getter</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">@Setter</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">@NoArgsConstructor</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">@AllArgsConstructor</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">@Builder</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">public class RaceStreamEntity {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    @Id</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    @GeneratedValue</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    @UuidGenerator</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    @Setter(AccessLevel.NONE)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    private UUID id;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    @Column(name = &quot;stream_id&quot;, unique = true)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    private String streamId; // Redis Stream ID (e.g., 1754326272465-45)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    @Column(name = &quot;rider&quot;)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    private String rider;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    @Column(name = &quot;speed&quot;)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    private Double speed;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    @Column(name = &quot;position&quot;)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    private Integer position;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    @Column(name = &quot;location_id&quot;)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    private Integer locationId;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    @Column(name = &quot;received_at&quot;)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    private LocalDateTime receivedAt;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span></code></pre></div></div>
<p>RaceStreamRepository.java</p>
<div class="language-java codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-java codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token annotation punctuation" style="color:#393A34">@Repository</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">public</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">interface</span><span class="token plain"> </span><span class="token class-name">RaceStreamRepository</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">extends</span><span class="token plain"> </span><span class="token class-name">JpaRepository</span><span class="token generics punctuation" style="color:#393A34">&lt;</span><span class="token generics class-name">RaceStreamEntity</span><span class="token generics punctuation" style="color:#393A34">,</span><span class="token generics"> UUID</span><span class="token generics punctuation" style="color:#393A34">&gt;</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token class-name">JpaSpecificationExecutor</span><span class="token generics punctuation" style="color:#393A34">&lt;</span><span class="token generics class-name">RaceStreamEntity</span><span class="token generics punctuation" style="color:#393A34">&gt;</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">boolean</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">existsByStreamId</span><span class="token punctuation" style="color:#393A34">(</span><span class="token class-name">String</span><span class="token plain"> streamId</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">}</span><br></span></code></pre></div></div>
<p>RaceStreamService.java</p>
<div class="language-text codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">@Slf4j</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">@Service</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">@RequiredArgsConstructor</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">public class RaceStreamService {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    private final StringRedisTemplate redisTemplate;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    private final RaceStreamRepository repository;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    private static final String STREAM_KEY = &quot;race:france&quot;;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    private static final String GROUP_NAME = &quot;race-group&quot;;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    private static final String CONSUMER_NAME = &quot;consumer-B&quot;;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    private final ExecutorService executor = Executors.newSingleThreadExecutor();</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    @PostConstruct</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    public void autoStartConsumer() {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        executor.submit(this::tailStream);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    @PostConstruct</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    public void init() {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        createGroupIfNotExists();</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    /*</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">     *   XGROUP CREATE race:france race-group 0 MKSTREAM</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">     */</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    private void createGroupIfNotExists() {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        try {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            redisTemplate.opsForStream().createGroup(STREAM_KEY, ReadOffset.from(&quot;0&quot;), GROUP_NAME);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            log.info(&quot;✅ Created group &#x27;{}&#x27; on stream &#x27;{}&#x27;&quot;, GROUP_NAME, STREAM_KEY);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        } catch (RedisSystemException e) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            if (e.getCause() instanceof RedisBusyException) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                log.info(&quot;ℹ️ Group &#x27;{}&#x27; already exists, skipping creation&quot;, GROUP_NAME);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            } else {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                throw e;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    @Scheduled(fixedDelay = 60000) // every 60 seconds</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    public void consumeStreamGroup() {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        StreamOperations&lt;String, Object, Object&gt; streamOps = redisTemplate.opsForStream();</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        try {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            /*</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">             *   XREADGROUP GROUP race-group consumer-B COUNT 10 BLOCK 5000 STREAMS race:france &gt;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">             */</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            List&lt;MapRecord&lt;String, Object, Object&gt;&gt; records = streamOps.read(</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                    Consumer.from(GROUP_NAME, CONSUMER_NAME),</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                    StreamReadOptions.empty().block(Duration.ofSeconds(5)).count(10),</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                    StreamOffset.create(STREAM_KEY, ReadOffset.lastConsumed())</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            );</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            if (records == null || records.isEmpty()) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                log.debug(&quot;⏳ No new messages.&quot;);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                return;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            for (MapRecord&lt;String, Object, Object&gt; record : records) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                String streamId = record.getId().getValue();</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                if (!repository.existsByStreamId(streamId)) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                    RaceStreamEntity entity = toEntity(record);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                    repository.save(entity);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                    // @TODO: Acknowledge after successful save</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                } else {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                    log.info(&quot;⚠️ Skipped duplicate streamId: {}&quot;, streamId);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        } catch (DataAccessException e) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            log.error(&quot;❌ Redis access error: {}&quot;, e.getMessage(), e);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        } catch (Exception e) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            log.error(&quot;❌ Unknown error in stream consumption&quot;, e);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    private RaceStreamEntity toEntity(MapRecord&lt;String, Object, Object&gt; record) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        Map&lt;Object, Object&gt; valueMap = record.getValue();</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        return RaceStreamEntity.builder()</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                .streamId(record.getId().getValue())</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                .rider(valueMap.getOrDefault(&quot;rider&quot;, &quot;&quot;).toString())</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                .speed(Double.parseDouble(valueMap.getOrDefault(&quot;speed&quot;, &quot;0&quot;).toString()))</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                .position(Integer.parseInt(valueMap.getOrDefault(&quot;position&quot;, &quot;0&quot;).toString()))</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                .locationId(Integer.parseInt(valueMap.getOrDefault(&quot;location_id&quot;, &quot;0&quot;).toString()))</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                .receivedAt(LocalDateTime.now())</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                .build();</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    public void tailStream() {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        StreamOperations&lt;String, Object, Object&gt; streamOps = redisTemplate.opsForStream();</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        String lastSeenId = &quot;$&quot;; // only new messages</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        while (true) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            try {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                List&lt;MapRecord&lt;String, Object, Object&gt;&gt; records = streamOps.read(</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                        StreamReadOptions.empty().block(Duration.ofSeconds(10)).count(10),</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                        StreamOffset.create(STREAM_KEY, ReadOffset.from(lastSeenId))</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                );</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                if (records == null || records.isEmpty()) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                    continue; // wait again</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                for (MapRecord&lt;String, Object, Object&gt; record : records) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                    String streamId = record.getId().getValue();</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                    if (!repository.existsByStreamId(streamId)) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                        RaceStreamEntity entry = toEntity(record);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                        repository.save(entry);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                    }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                    lastSeenId = streamId;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            } catch (Exception ex) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                ex.printStackTrace(); // log and continue</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span></code></pre></div></div>
<p>from the DemoApplication.java</p>
<div class="language-java codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-java codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token annotation punctuation" style="color:#393A34">@SpringBootApplication</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token annotation punctuation" style="color:#393A34">@EnableScheduling</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">public</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">class</span><span class="token plain"> </span><span class="token class-name">DemoApplication</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	</span><span class="token keyword" style="color:#00009f">public</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">static</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">void</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">main</span><span class="token punctuation" style="color:#393A34">(</span><span class="token class-name">String</span><span class="token punctuation" style="color:#393A34">[</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain"> args</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">		</span><span class="token class-name">SpringApplication</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">run</span><span class="token punctuation" style="color:#393A34">(</span><span class="token class-name">DemoApplication</span><span class="token punctuation" style="color:#393A34">.</span><span class="token keyword" style="color:#00009f">class</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> args</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	</span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">}</span><br></span></code></pre></div></div>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="what-the-spring-boot-program-is-doing">What the Spring Boot Program Is Doing<a href="#what-the-spring-boot-program-is-doing" class="hash-link" aria-label="Direct link to What the Spring Boot Program Is Doing" title="Direct link to What the Spring Boot Program Is Doing">​</a></h2>
<p>Spring Boot program is doing stream consumption from Redis and persisting stream entries into a database, with the following key steps:</p>
<p><strong>1. Creates the Consumer Group (Once at Startup)</strong></p>
<div class="language-java codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-java codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token annotation punctuation" style="color:#393A34">@PostConstruct</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">public</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">void</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">init</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    redisTemplate</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">opsForStream</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">createGroup</span><span class="token punctuation" style="color:#393A34">(</span><span class="token constant" style="color:#36acaa">STREAM_KEY</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token class-name">ReadOffset</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">from</span><span class="token punctuation" style="color:#393A34">(</span><span class="token string" style="color:#e3116c">&quot;0&quot;</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token constant" style="color:#36acaa">GROUP_NAME</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">}</span><br></span></code></pre></div></div>
<ul>
<li>This is equivalent to:<!-- -->
<div class="language-text codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">XGROUP CREATE race:france race-group 0 MKSTREAM</span><br></span></code></pre></div></div>
</li>
<li>It ensures the consumer group race-group is created for stream race<!-- -->:france<!-- -->.</li>
</ul>
<p><strong>2. Schedules a Consumer Task (Every 60 Seconds)</strong></p>
<div class="language-java codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-java codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token annotation punctuation" style="color:#393A34">@Scheduled</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">fixedDelay </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">60000</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token comment" style="color:#999988;font-style:italic">// every 60s</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">public</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">void</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">consumeStreamGroup</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><br></span></code></pre></div></div>
<ul>
<li>This is your background stream processor.</li>
<li>It runs every minute to read from the Redis stream using the consumer group model.</li>
</ul>
<p><strong>3. Reads Undelivered Messages via XREADGROUP</strong></p>
<div class="language-java codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-java codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">streamOps</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">read</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token class-name">Consumer</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">from</span><span class="token punctuation" style="color:#393A34">(</span><span class="token constant" style="color:#36acaa">GROUP_NAME</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token constant" style="color:#36acaa">CONSUMER_NAME</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token class-name">StreamReadOptions</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">empty</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">block</span><span class="token punctuation" style="color:#393A34">(</span><span class="token class-name">Duration</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">ofSeconds</span><span class="token punctuation" style="color:#393A34">(</span><span class="token number" style="color:#36acaa">5</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">count</span><span class="token punctuation" style="color:#393A34">(</span><span class="token number" style="color:#36acaa">10</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token class-name">StreamOffset</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">create</span><span class="token punctuation" style="color:#393A34">(</span><span class="token constant" style="color:#36acaa">STREAM_KEY</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token class-name">ReadOffset</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">lastConsumed</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">)</span><br></span></code></pre></div></div>
<ul>
<li>Equivalent Redis CLI:<!-- -->
<div class="language-text codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">XREADGROUP GROUP race-group consumer-B COUNT 10 BLOCK 5000 STREAMS race:france &gt;</span><br></span></code></pre></div></div>
</li>
<li>What it does:<!-- -->
<ul>
<li>Reads new messages (&gt;) for consumer-B</li>
<li>Redis tracks what messages were delivered but not acknowledged</li>
</ul>
</li>
</ul>
<p><strong>4. Persists Each Entry to H2 Database</strong></p>
<div class="language-java codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-java codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token keyword" style="color:#00009f">if</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token operator" style="color:#393A34">!</span><span class="token plain">repository</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">existsByStreamId</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">streamId</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token class-name">RaceStreamEntity</span><span class="token plain"> entity </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">toEntity</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">record</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    repository</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">save</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">entity</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">}</span><br></span></code></pre></div></div>
<ul>
<li>Avoids duplicates by checking if streamId was already saved</li>
<li>Maps Redis stream fields (e.g., rider, speed, etc.) to a JPA entity</li>
<li>Stores them into your in-memory H2 table race_stream_entry</li>
</ul>
<p><strong>5. No Interruption</strong></p>
<p>While the program is actively running—but before all previous messages have been processed—if you execute an <strong>XADD</strong>, the new message will still be picked up and persisted to the database without interruption.</p>
<div class="language-text codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">XADD race:france * rider &quot;Pogacar&quot; speed 38.9 position 1 location_id 1</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">&quot;1754485788977-0&quot;</span><br></span></code></pre></div></div>
<p>Unlike the @Scheduled polling approach (which may introduce delays), this tailing consumer loop continuously listens using BLOCK, allowing it to process newly added messages immediately, even while older entries are still being handled.
✅ The processing is seamless and non-blocking across messages, and no messages are skipped or lost (as long as each is uniquely stored by streamId).</p>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="-whats-missing-or-not-yet-implemented">❌ What’s Missing or Not Yet Implemented?<a href="#-whats-missing-or-not-yet-implemented" class="hash-link" aria-label="Direct link to ❌ What’s Missing or Not Yet Implemented?" title="Direct link to ❌ What’s Missing or Not Yet Implemented?">​</a></h2>
<blockquote>
<blockquote>
<p>You haven’t acknowledged any message yet.</p>
</blockquote>
</blockquote>
<h4 class="anchor anchorWithStickyNavbar_LWe7" id="in-redis-terms">In Redis terms:<a href="#in-redis-terms" class="hash-link" aria-label="Direct link to In Redis terms:" title="Direct link to In Redis terms:">​</a></h4>
<ul>
<li>
<p>Messages delivered to the consumer stay in the Pending Entries List (PEL) until you XACK them.</p>
<div class="language-text codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">if (!repository.existsByStreamId(streamId)) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    RaceStreamEntity entity = toEntity(record);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    repository.save(entity);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    // ✅ Acknowledge this message after successful save</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    streamOps.acknowledge(STREAM_KEY, GROUP_NAME, record.getId());</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    log.info(&quot;✅ Acknowledged stream ID {}&quot;, streamId);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span></code></pre></div></div>
</li>
<li>
<p>This means:</p>
<ul>
<li>Redis thinks they are still &quot;unprocessed&quot; or &quot;pending retry&quot;</li>
<li>If the consumer crashes or restarts, Redis will not re-deliver these messages unless you recover them manually or auto-claim them (XAUTOCLAIM / XCLAIM)</li>
</ul>
</li>
<li>
<p><strong>Retry Logic for Failed Saves</strong></p>
<ul>
<li>If you want reliability, you can implement retry mechanisms for failed DB writes, and only XACK after success.</li>
<li>Use XAUTOCLAIM to recover stuck messages</li>
<li>Add dead-letter queue if a message repeatedly fails</li>
</ul>
</li>
<li>
<p><strong>Gracefully shutdown:</strong></p>
<div class="language-text codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">@PreDestroy</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">public void shutdown() {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    running = false;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    executor.shutdownNow(); // Optional: force shutdown if needed</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    log.info(&quot;🔴 Stream consumer stopped.&quot;);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span></code></pre></div></div>
</li>
</ul>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="best-pratices">Best Pratices<a href="#best-pratices" class="hash-link" aria-label="Direct link to Best Pratices" title="Direct link to Best Pratices">​</a></h2>
<p>In production systems, we typically avoid using @Scheduled for real-time stream consumption, especially when working with Redis Streams (or Kafka, RabbitMQ, etc.). Scheduled polling introduces latency, wasted CPU cycles, and potential inconsistencies when manually tracking offsets like the last seen record ID.</p>
<p>Instead, a production-grade Redis Stream consumer should be designed to:</p>
<ul>
<li>Start automatically when the application starts</li>
<li>Run in a continuous background thread or task</li>
<li>Use XREADGROUP with BLOCK to efficiently wait for new messages in an event-driven manner</li>
<li>Use XACK after successful processing to let Redis handle delivery state</li>
</ul>
<p>👉 This approach simulates the ideal pattern for overcoming previous issues with XREAD, where developers had to manually track and persist the last seen ID (e.g. via $, specific stream ID, or 0-0).
By using XREADGROUP with BLOCK, Redis remembers what messages have or haven’t been delivered to each consumer group, and automatically resumes from the correct position — eliminating the need to self-manage offset tracking.
The thread is only interrupted when new data arrives or during shutdown, ensuring high efficiency and reliability in stream processing.</p>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="1-kick-off-consumer-in-postconstruct-or-eventlistener">1. Kick Off Consumer in @PostConstruct or @EventListener<a href="#1-kick-off-consumer-in-postconstruct-or-eventlistener" class="hash-link" aria-label="Direct link to 1. Kick Off Consumer in @PostConstruct or @EventListener" title="Direct link to 1. Kick Off Consumer in @PostConstruct or @EventListener">​</a></h3>
<p>Either of these works:</p>
<div class="language-java codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-java codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token annotation punctuation" style="color:#393A34">@PostConstruct</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">public</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">void</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">startConsumerThread</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">.</span><span class="token punctuation" style="color:#393A34">.</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token operator" style="color:#393A34">--</span><span class="token plain"> or </span><span class="token operator" style="color:#393A34">--</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token annotation punctuation" style="color:#393A34">@EventListener</span><span class="token punctuation" style="color:#393A34">(</span><span class="token class-name">ApplicationReadyEvent</span><span class="token punctuation" style="color:#393A34">.</span><span class="token keyword" style="color:#00009f">class</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">public</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">void</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">startConsumerThread</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">.</span><span class="token punctuation" style="color:#393A34">.</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">}</span><br></span></code></pre></div></div>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="2--use-a-long-running-background-thread">2.  Use a Long-Running Background Thread<a href="#2--use-a-long-running-background-thread" class="hash-link" aria-label="Direct link to 2.  Use a Long-Running Background Thread" title="Direct link to 2.  Use a Long-Running Background Thread">​</a></h3>
<div class="language-text codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">Executors.newSingleThreadExecutor().submit(() -&gt; {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    while (true) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        List&lt;MapRecord&lt;String, Object, Object&gt;&gt; records = redisTemplate.opsForStream().read(</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            Consumer.from(&quot;race-group&quot;, &quot;consumer-B&quot;),</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            StreamReadOptions.empty().block(Duration.ofSeconds(30)).count(10),</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            StreamOffset.create(&quot;race:france&quot;, ReadOffset.lastConsumed())</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        );</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        for (MapRecord&lt;String, Object, Object&gt; record : records) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            // process and XACK</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">});</span><br></span></code></pre></div></div>
<p>Example:</p>
<div class="language-java codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-java codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token annotation punctuation" style="color:#393A34">@Component</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token annotation punctuation" style="color:#393A34">@RequiredArgsConstructor</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">public</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">class</span><span class="token plain"> </span><span class="token class-name">RedisStreamConsumer</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">private</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">final</span><span class="token plain"> </span><span class="token class-name">StringRedisTemplate</span><span class="token plain"> redisTemplate</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">private</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">final</span><span class="token plain"> </span><span class="token class-name">RaceStreamRepository</span><span class="token plain"> repository</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">private</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">final</span><span class="token plain"> </span><span class="token class-name">ExecutorService</span><span class="token plain"> executor </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token class-name">Executors</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">newSingleThreadExecutor</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">private</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">volatile</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">boolean</span><span class="token plain"> running </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token boolean" style="color:#36acaa">true</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">private</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">static</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">final</span><span class="token plain"> </span><span class="token class-name">String</span><span class="token plain"> </span><span class="token constant" style="color:#36acaa">STREAM_KEY</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&quot;race:france&quot;</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">private</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">static</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">final</span><span class="token plain"> </span><span class="token class-name">String</span><span class="token plain"> </span><span class="token constant" style="color:#36acaa">GROUP_NAME</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&quot;race-group&quot;</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">private</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">static</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">final</span><span class="token plain"> </span><span class="token class-name">String</span><span class="token plain"> </span><span class="token constant" style="color:#36acaa">CONSUMER_NAME</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&quot;consumer-B&quot;</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token annotation punctuation" style="color:#393A34">@EventListener</span><span class="token punctuation" style="color:#393A34">(</span><span class="token class-name">ApplicationReadyEvent</span><span class="token punctuation" style="color:#393A34">.</span><span class="token keyword" style="color:#00009f">class</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">public</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">void</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">startConsumerThread</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        executor</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">submit</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">-&gt;</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            </span><span class="token keyword" style="color:#00009f">while</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">running</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                </span><span class="token keyword" style="color:#00009f">try</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                    </span><span class="token class-name">List</span><span class="token generics punctuation" style="color:#393A34">&lt;</span><span class="token generics class-name">MapRecord</span><span class="token generics punctuation" style="color:#393A34">&lt;</span><span class="token generics class-name">String</span><span class="token generics punctuation" style="color:#393A34">,</span><span class="token generics"> </span><span class="token generics class-name">Object</span><span class="token generics punctuation" style="color:#393A34">,</span><span class="token generics"> </span><span class="token generics class-name">Object</span><span class="token generics punctuation" style="color:#393A34">&gt;</span><span class="token generics punctuation" style="color:#393A34">&gt;</span><span class="token plain"> records </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> redisTemplate</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">opsForStream</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">read</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                        </span><span class="token class-name">Consumer</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">from</span><span class="token punctuation" style="color:#393A34">(</span><span class="token constant" style="color:#36acaa">GROUP_NAME</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token constant" style="color:#36acaa">CONSUMER_NAME</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                        </span><span class="token class-name">StreamReadOptions</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">empty</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">block</span><span class="token punctuation" style="color:#393A34">(</span><span class="token class-name">Duration</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">ofSeconds</span><span class="token punctuation" style="color:#393A34">(</span><span class="token number" style="color:#36acaa">30</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">count</span><span class="token punctuation" style="color:#393A34">(</span><span class="token number" style="color:#36acaa">10</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                        </span><span class="token class-name">StreamOffset</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">create</span><span class="token punctuation" style="color:#393A34">(</span><span class="token constant" style="color:#36acaa">STREAM_KEY</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token class-name">ReadOffset</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">lastConsumed</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                    </span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                    </span><span class="token keyword" style="color:#00009f">if</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">records </span><span class="token operator" style="color:#393A34">==</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">null</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">||</span><span class="token plain"> records</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">isEmpty</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                        </span><span class="token keyword" style="color:#00009f">continue</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"> </span><span class="token comment" style="color:#999988;font-style:italic">// Wait again</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                    </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                    </span><span class="token keyword" style="color:#00009f">for</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token class-name">MapRecord</span><span class="token generics punctuation" style="color:#393A34">&lt;</span><span class="token generics class-name">String</span><span class="token generics punctuation" style="color:#393A34">,</span><span class="token generics"> </span><span class="token generics class-name">Object</span><span class="token generics punctuation" style="color:#393A34">,</span><span class="token generics"> </span><span class="token generics class-name">Object</span><span class="token generics punctuation" style="color:#393A34">&gt;</span><span class="token plain"> record </span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> records</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                        </span><span class="token class-name">String</span><span class="token plain"> streamId </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> record</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">getId</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">getValue</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                        </span><span class="token keyword" style="color:#00009f">if</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token operator" style="color:#393A34">!</span><span class="token plain">repository</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">existsByStreamId</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">streamId</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                            repository</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">save</span><span class="token punctuation" style="color:#393A34">(</span><span class="token function" style="color:#d73a49">toEntity</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">record</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                            redisTemplate</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">opsForStream</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">acknowledge</span><span class="token punctuation" style="color:#393A34">(</span><span class="token constant" style="color:#36acaa">STREAM_KEY</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token constant" style="color:#36acaa">GROUP_NAME</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> record</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">getId</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                        </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                    </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">catch</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token class-name">Exception</span><span class="token plain"> e</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                    log</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">error</span><span class="token punctuation" style="color:#393A34">(</span><span class="token string" style="color:#e3116c">&quot;Stream processing error&quot;</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> e</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                    </span><span class="token keyword" style="color:#00009f">try</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                        </span><span class="token class-name">Thread</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">sleep</span><span class="token punctuation" style="color:#393A34">(</span><span class="token number" style="color:#36acaa">1000</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"> </span><span class="token comment" style="color:#999988;font-style:italic">// Optional backoff</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                    </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">catch</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token class-name">InterruptedException</span><span class="token plain"> ie</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                        </span><span class="token class-name">Thread</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">currentThread</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">interrupt</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                        </span><span class="token keyword" style="color:#00009f">break</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                    </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            log</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">info</span><span class="token punctuation" style="color:#393A34">(</span><span class="token string" style="color:#e3116c">&quot;🛑 Redis Stream consumer has stopped.&quot;</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token punctuation" style="color:#393A34">}</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token annotation punctuation" style="color:#393A34">@PreDestroy</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">public</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">void</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">shutdownConsumer</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        running </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token boolean" style="color:#36acaa">false</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        executor</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">shutdownNow</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"> </span><span class="token comment" style="color:#999988;font-style:italic">// Optional: force interrupt</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        log</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">info</span><span class="token punctuation" style="color:#393A34">(</span><span class="token string" style="color:#e3116c">&quot;🔴 Graceful shutdown triggered for Redis consumer.&quot;</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">private</span><span class="token plain"> </span><span class="token class-name">RaceStreamEntity</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">toEntity</span><span class="token punctuation" style="color:#393A34">(</span><span class="token class-name">MapRecord</span><span class="token generics punctuation" style="color:#393A34">&lt;</span><span class="token generics class-name">String</span><span class="token generics punctuation" style="color:#393A34">,</span><span class="token generics"> </span><span class="token generics class-name">Object</span><span class="token generics punctuation" style="color:#393A34">,</span><span class="token generics"> </span><span class="token generics class-name">Object</span><span class="token generics punctuation" style="color:#393A34">&gt;</span><span class="token plain"> record</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token class-name">Map</span><span class="token generics punctuation" style="color:#393A34">&lt;</span><span class="token generics class-name">Object</span><span class="token generics punctuation" style="color:#393A34">,</span><span class="token generics"> </span><span class="token generics class-name">Object</span><span class="token generics punctuation" style="color:#393A34">&gt;</span><span class="token plain"> m </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> record</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">getValue</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token keyword" style="color:#00009f">return</span><span class="token plain"> </span><span class="token class-name">RaceStreamEntity</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">builder</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                </span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">streamId</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">record</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">getId</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">getValue</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                </span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">rider</span><span class="token punctuation" style="color:#393A34">(</span><span class="token class-name">String</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">valueOf</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">m</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">get</span><span class="token punctuation" style="color:#393A34">(</span><span class="token string" style="color:#e3116c">&quot;rider&quot;</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                </span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">speed</span><span class="token punctuation" style="color:#393A34">(</span><span class="token class-name">Double</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">valueOf</span><span class="token punctuation" style="color:#393A34">(</span><span class="token class-name">String</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">valueOf</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">m</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">get</span><span class="token punctuation" style="color:#393A34">(</span><span class="token string" style="color:#e3116c">&quot;speed&quot;</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                </span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">position</span><span class="token punctuation" style="color:#393A34">(</span><span class="token class-name">Integer</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">valueOf</span><span class="token punctuation" style="color:#393A34">(</span><span class="token class-name">String</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">valueOf</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">m</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">get</span><span class="token punctuation" style="color:#393A34">(</span><span class="token string" style="color:#e3116c">&quot;position&quot;</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                </span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">locationId</span><span class="token punctuation" style="color:#393A34">(</span><span class="token class-name">Integer</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">valueOf</span><span class="token punctuation" style="color:#393A34">(</span><span class="token class-name">String</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">valueOf</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">m</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">get</span><span class="token punctuation" style="color:#393A34">(</span><span class="token string" style="color:#e3116c">&quot;location_id&quot;</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                </span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">receivedAt</span><span class="token punctuation" style="color:#393A34">(</span><span class="token class-name">LocalDateTime</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">now</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                </span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">build</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span></code></pre></div></div>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="additional-information-on-block">Additional Information on BLOCK<a href="#additional-information-on-block" class="hash-link" aria-label="Direct link to Additional Information on BLOCK" title="Direct link to Additional Information on BLOCK">​</a></h2>
<p>Redis is single-threaded for command execution, but your Java program is not — and BLOCK 0 (or BLOCK N) doesn&#x27;t block Redis itself; it only blocks the client connection (your thread), not the server.</p>
<h4 class="anchor anchorWithStickyNavbar_LWe7" id="key-understanding-who-is-blocking-whom">Key Understanding: Who Is Blocking Whom?<a href="#key-understanding-who-is-blocking-whom" class="hash-link" aria-label="Direct link to Key Understanding: Who Is Blocking Whom?" title="Direct link to Key Understanding: Who Is Blocking Whom?">​</a></h4>
<ul>
<li><code>BLOCK</code> blocks the client-side connection, not Redis.</li>
<li>When you call:<!-- -->
<div class="language-text codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">XREAD BLOCK 0 STREAMS race:france &gt;</span><br></span></code></pre></div></div>
<ul>
<li>Redis does not block its own execution</li>
<li>It just holds that one client connection open, waiting for new data</li>
<li>Other clients (your app, other services) can still run commands freely</li>
</ul>
</li>
<li><code>BLOCK</code> is not a sleep, it is a timeout<!-- -->
<ul>
<li>“Wait up to 30 seconds for a message to arrive.</li>
<li>If a message comes in earlier, return immediately.</li>
<li>If nothing arrives within 30 seconds, return null.”</li>
<li>⛔ It does not idle or sleep for 30 seconds after returning.</li>
<li>✅ It just returns immediately, and your code continues executing.</li>
</ul>
</li>
</ul>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="timeline-visualization">Timeline Visualization<a href="#timeline-visualization" class="hash-link" aria-label="Direct link to Timeline Visualization" title="Direct link to Timeline Visualization">​</a></h3>
<table><thead><tr><th>Time (s)</th><th>Event</th></tr></thead><tbody><tr><td>0</td><td>You call <code>.read(BLOCK 30)</code></td></tr><tr><td>30</td><td>No message — Redis returns <code>null</code></td></tr><tr><td>30–35</td><td>Your code loops again, calls <code>.read(BLOCK 30)</code> again</td></tr><tr><td>35</td><td>Message arrives</td></tr><tr><td>35–36</td><td>Redis immediately returns the message to the new read()</td></tr><tr><td>36+</td><td>Your code processes the message</td></tr></tbody></table>
<h4 class="anchor anchorWithStickyNavbar_LWe7" id="analogy">Analogy<a href="#analogy" class="hash-link" aria-label="Direct link to Analogy" title="Direct link to Analogy">​</a></h4>
<p>Imagine Redis as a waiter:</p>
<ul>
<li>You (client A) say: &quot;Wait at my table until food is ready.&quot; (BLOCK)</li>
<li>The waiter just keeps your request on hold</li>
<li>Meanwhile, the waiter continues to serve other tables (clients)</li>
<li>When food (message) is ready, the waiter replies to you</li>
<li>So Redis is not blocked. Just your request is suspended until fulfilled.</li>
</ul>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="in-java-terms">In Java Terms<a href="#in-java-terms" class="hash-link" aria-label="Direct link to In Java Terms" title="Direct link to In Java Terms">​</a></h3>
<div class="language-text codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">List&lt;MapRecord&lt;...&gt;&gt; records = streamOps.read(... BLOCK 0 ...);</span><br></span></code></pre></div></div>
<ul>
<li>This blocks only that Java thread (e.g. inside your Runnable / Executor)</li>
<li>Redis is totally fine — other operations like XADD, XINFO, or even other consumers continue running</li>
<li>Your app can run hundreds of threads, each with their own BLOCK calls, if needed</li>
<li>You Can Safely Use BLOCK 0 in Production</li>
<li>The only <strong>drawback</strong> is graceful shutdown more difficult — not impossible, but you’ll need extra work to support it.</li>
</ul>
<div class="language-text codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">List&lt;MapRecord&lt;...&gt;&gt; records = streamOps.read(... BLOCK 5 or 10 ...);</span><br></span></code></pre></div></div>
<ul>
<li>Fast enough for near real-time</li>
<li>Easy to exit on shutdown (running flag)</li>
<li>You don’t need ultra-low latency (sub-second responsiveness)</li>
<li>Your thread will resume and do a null check every 5s or 10s depends what you set it</li>
<li>Slight increase in Redis commands, Redis receives a command every 30s per consumer</li>
<li>Slight latency on arrival. If a message arrives at second 0.1, your code may not see it until second 30 (worst case)</li>
</ul>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="summary">Summary<a href="#summary" class="hash-link" aria-label="Direct link to Summary" title="Direct link to Summary">​</a></h2>
<table><thead><tr><th>Use Case</th><th>Create consumer?</th><th>Use <code>XREADGROUP</code>?</th><th>Use <code>XREAD</code>?</th></tr></thead><tbody><tr><td>Single user reads stream</td><td>❌ No</td><td>❌ No</td><td>✅ Yes</td></tr><tr><td>Multiple consumers (shared work)</td><td>✅ Yes</td><td>✅ Yes</td><td>❌ No</td></tr><tr><td>Need retries, reliability</td><td>✅ Yes</td><td>✅ Yes</td><td>❌ No</td></tr></tbody></table>
<p>Redis tracks:</p>
<ul>
<li>Each consumer (e.g., consumer-1, consumer-2)</li>
<li>Which message was delivered to which consumer</li>
<li>Which messages are pending acknowledgment</li>
</ul></div><footer class="theme-doc-footer docusaurus-mt-lg"><div class="row margin-top--sm theme-doc-footer-edit-meta-row"><div class="col"><a href="https://github.com/facebook/docusaurus/tree/main/packages/create-docusaurus/templates/shared/docs/tutorial-basics/08-xgroup-consumer.mdx" target="_blank" rel="noopener noreferrer" class="theme-edit-this-page"><svg fill="currentColor" height="20" width="20" viewBox="0 0 40 40" class="iconEdit_Z9Sw" aria-hidden="true"><g><path d="m34.5 11.7l-3 3.1-6.3-6.3 3.1-3q0.5-0.5 1.2-0.5t1.1 0.5l3.9 3.9q0.5 0.4 0.5 1.1t-0.5 1.2z m-29.5 17.1l18.4-18.5 6.3 6.3-18.4 18.4h-6.3v-6.2z"></path></g></svg>Edit this page</a></div><div class="col lastUpdated_JAkA"></div></div></footer></article><nav class="docusaurus-mt-lg pagination-nav" aria-label="Docs pages"><a class="pagination-nav__link pagination-nav__link--prev" href="/spring-data-redis-streams/docs/tutorial-basics/xread/"><div class="pagination-nav__sublabel">Previous</div><div class="pagination-nav__label">XREAD</div></a><a class="pagination-nav__link pagination-nav__link--next" href="/spring-data-redis-streams/docs/tutorial-basics/xack/"><div class="pagination-nav__sublabel">Next</div><div class="pagination-nav__label">XACK</div></a></nav></div></div><div class="col col--3"><div class="tableOfContents_bqdL thin-scrollbar theme-doc-toc-desktop"><ul class="table-of-contents table-of-contents__left-border"><li><a href="#redis-cli" class="table-of-contents__link toc-highlight">Redis CLI</a></li><li><a href="#create-group-mandatory" class="table-of-contents__link toc-highlight">Create Group (Mandatory)</a></li><li><a href="#consumer-creation-optional" class="table-of-contents__link toc-highlight">Consumer Creation (Optional)</a></li><li><a href="#consuming-messages" class="table-of-contents__link toc-highlight">Consuming Messages</a></li><li><a href="#full-example" class="table-of-contents__link toc-highlight">Full example</a></li><li><a href="#understanding-behavior-of-xgroup-create--0--" class="table-of-contents__link toc-highlight">Understanding Behavior of XGROUP CREATE ... 0 + &gt;</a></li><li><a href="#practice-1--using--to-fetch-in-batches" class="table-of-contents__link toc-highlight">Practice #1 – Using &gt; to Fetch in Batches</a></li><li><a href="#practice-2--using-0-to-fetch-pending-messages" class="table-of-contents__link toc-highlight">Practice #2 – Using 0 to Fetch Pending Messages</a></li><li><a href="#confirm-with-xpending" class="table-of-contents__link toc-highlight">Confirm with XPENDING</a></li><li><a href="#adding-more-consumers" class="table-of-contents__link toc-highlight">Adding More Consumers</a></li><li><a href="#spring-data-redis-integration" class="table-of-contents__link toc-highlight">Spring Data Redis Integration</a></li><li><a href="#what-the-spring-boot-program-is-doing" class="table-of-contents__link toc-highlight">What the Spring Boot Program Is Doing</a></li><li><a href="#-whats-missing-or-not-yet-implemented" class="table-of-contents__link toc-highlight">❌ What’s Missing or Not Yet Implemented?</a></li><li><a href="#best-pratices" class="table-of-contents__link toc-highlight">Best Pratices</a><ul><li><a href="#1-kick-off-consumer-in-postconstruct-or-eventlistener" class="table-of-contents__link toc-highlight">1. Kick Off Consumer in @PostConstruct or @EventListener</a></li><li><a href="#2--use-a-long-running-background-thread" class="table-of-contents__link toc-highlight">2.  Use a Long-Running Background Thread</a></li></ul></li><li><a href="#additional-information-on-block" class="table-of-contents__link toc-highlight">Additional Information on BLOCK</a><ul><li><a href="#timeline-visualization" class="table-of-contents__link toc-highlight">Timeline Visualization</a></li><li><a href="#in-java-terms" class="table-of-contents__link toc-highlight">In Java Terms</a></li></ul></li><li><a href="#summary" class="table-of-contents__link toc-highlight">Summary</a></li></ul></div></div></div></div></main></div></div></div><footer class="theme-layout-footer footer footer--dark"><div class="container container-fluid"><div class="row footer__links"><div class="theme-layout-footer-column col footer__col"><div class="footer__title">Docs</div><ul class="footer__items clean-list"><li class="footer__item"><a class="footer__link-item" href="/spring-data-redis-streams/docs/intro/">Tutorial</a></li></ul></div><div class="theme-layout-footer-column col footer__col"><div class="footer__title">Community</div><ul class="footer__items clean-list"><li class="footer__item"><a href="https://stackoverflow.com/questions/tagged/docusaurus" target="_blank" rel="noopener noreferrer" class="footer__link-item">Stack Overflow<svg width="13.5" height="13.5" aria-hidden="true" class="iconExternalLink_nPIU"><use href="#theme-svg-external-link"></use></svg></a></li><li class="footer__item"><a href="https://discordapp.com/invite/docusaurus" target="_blank" rel="noopener noreferrer" class="footer__link-item">Discord<svg width="13.5" height="13.5" aria-hidden="true" class="iconExternalLink_nPIU"><use href="#theme-svg-external-link"></use></svg></a></li><li class="footer__item"><a href="https://x.com/docusaurus" target="_blank" rel="noopener noreferrer" class="footer__link-item">X<svg width="13.5" height="13.5" aria-hidden="true" class="iconExternalLink_nPIU"><use href="#theme-svg-external-link"></use></svg></a></li></ul></div></div><div class="footer__bottom text--center"><div class="footer__copyright">Copyright © 2025 My Project, Inc. Built with Docusaurus.</div></div></div></footer></div>
</body>
</html>